<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Experience - GLB Model</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
            max-width: 350px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        #arButton {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            z-index: 100;
            display: none;
        }
        
        #arButton:hover {
            background: #0056b3;
        }
        
        #arButton:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success { color: #4CAF50; }
        .error { color: #f44336; }
    </style>
</head>
<body>
    <div id="container">
        <div id="info">
            <h3>AR FBX Model Viewer</h3>
            <p id="status">Initializing...</p>
        </div>
        
        <div id="loading">
            <div class="spinner"></div>
            <p>Loading 3D model...</p>
        </div>
        
        <button id="arButton">Enter AR</button>
    </div>

    <!-- Load Three.js and GLTFLoader from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    
    <script>
        let scene, camera, renderer, model;
        let arButton = document.getElementById('arButton');
        let loadingDiv = document.getElementById('loading');
        let statusP = document.getElementById('status');
        
        // Your GLB model URL
        const modelURL = 'https://juneatkins24-bot.github.io/bride-ar-model/Untitled-v4.glb';
        
        function updateStatus(message, className = '') {
            statusP.innerHTML = `<span class="${className}">${message}</span>`;
            console.log(message);
        }
        
        function init() {
            updateStatus('Setting up 3D scene...');
            
            // Create scene
            scene = new THREE.Scene();
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 3);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.xr.enabled = true;
            document.getElementById('container').appendChild(renderer.domElement);
            
            // Add lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // Add ground plane for AR reference
            const groundGeometry = new THREE.PlaneGeometry(20, 20);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x999999, 
                transparent: true, 
                opacity: 0.3 
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -1;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Load the GLB model
            loadGLBModel();
            
            // Check for AR support
            checkARSupport();
            
            // Start animation loop
            animate();
        }
        
        function loadGLBModel() {
            updateStatus('Loading your GLB model...');
            
            // Check if GLTFLoader is available
            if (typeof THREE.GLTFLoader === 'undefined') {
                updateStatus('❌ GLTFLoader not available', 'error');
                createFallbackModel();
                return;
            }
            
            const loader = new THREE.GLTFLoader();
            
            // First, let's test if the file is accessible
            fetch(modelURL, { method: 'HEAD' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`File not accessible: ${response.status}`);
                    }
                    updateStatus('✓ GLB file is accessible, loading...');
                    
                    // Now load with GLTFLoader
                    loader.load(
                        modelURL,
                        // Success callback
                        function(gltf) {
                            model = gltf.scene;
                            
                            // Configure model
                            model.traverse((child) => {
                                if (child.isMesh) {
                                    child.castShadow = true;
                                    child.receiveShadow = true;
                                }
                            });
                            
                            // Auto-scale and center the model
                            const box = new THREE.Box3().setFromObject(model);
                            const size = box.getSize(new THREE.Vector3());
                            const maxDimension = Math.max(size.x, size.y, size.z);
                            const scale = 2 / maxDimension; // Scale to about 2 units max
                            model.scale.setScalar(scale);
                            
                            // Center the model
                            const center = box.getCenter(new THREE.Vector3());
                            model.position.copy(center).multiplyScalar(-scale);
                            model.position.y = 0; // Place on ground
                            
                            scene.add(model);
                            
                            loadingDiv.style.display = 'none';
                            updateStatus('✓ GLB model loaded successfully!', 'success');
                            
                            // Add model info
                            setTimeout(() => {
                                const info = document.createElement('div');
                                info.innerHTML = `
                                    <hr>
                                    <p><strong>Model Info:</strong></p>
                                    <p>• Original size: ${size.x.toFixed(2)} × ${size.y.toFixed(2)} × ${size.z.toFixed(2)}</p>
                                    <p>• Scale factor: ${scale.toFixed(2)}</p>
                                    <p>• Meshes: ${countMeshes(model)}</p>
                                    <p class="success">Ready for AR!</p>
                                `;
                                document.getElementById('info').appendChild(info);
                            }, 1000);
                        },
                        // Progress callback
                        function(progress) {
                            if (progress.lengthComputable) {
                                const percent = Math.round((progress.loaded / progress.total) * 100);
                                updateStatus(`Loading GLB model... ${percent}%`);
                            } else {
                                updateStatus('Loading GLB model...');
                            }
                        },
                        // Error callback
                        function(error) {
                            console.error('GLB loading error:', error);
                            
                            // Check if it's a compression error
                            if (error.message && error.message.includes('meshopt')) {
                                updateStatus('❌ Model uses unsupported compression', 'error');
                                showCompressionHelp();
                            } else {
                                updateStatus('❌ Failed to load GLB model', 'error');
                            }
                            createFallbackModel();
                        }
                    );
                })
                .catch(error => {
                    console.error('File access error:', error);
                    updateStatus('❌ Cannot access GLB file', 'error');
                    createFallbackModel();
                });
        }
        
        function countMeshes(object) {
            let count = 0;
            object.traverse((child) => {
                if (child.isMesh) count++;
            });
            return count;
        }
        
        function showCompressionHelp() {
            const help = document.createElement('div');
            help.innerHTML = `
                <hr>
                <p class="error"><strong>Compression Issue</strong></p>
                <p>Your GLB file uses Meshopt compression which isn't supported in this simple viewer.</p>
                <p><strong>Solutions:</strong></p>
                <p>1. Re-export your model without compression</p>
                <p>2. Use Draco compression instead</p>
                <p>3. Use an uncompressed GLB format</p>
                <p><strong>Test:</strong> <a href="${modelURL}" target="_blank">Download your GLB file</a></p>
            `;
            document.getElementById('info').appendChild(help);
        }
        
        function createFallbackModel() {
            updateStatus('Creating fallback model...', 'error');
            
            // Create a distinctive fallback
            const geometry = new THREE.ConeGeometry(0.5, 1, 8);
            const material = new THREE.MeshLambertMaterial({ color: 0xff6b6b });
            model = new THREE.Mesh(geometry, material);
            model.position.set(0, 0.5, 0);
            model.castShadow = true;
            scene.add(model);
            
            loadingDiv.style.display = 'none';
            
            const troubleshoot = document.createElement('div');
            troubleshoot.innerHTML = `
                <hr>
                <p class="error"><strong>Using Fallback Model</strong></p>
                <p>Your GLB file: <a href="${modelURL}" target="_blank">Test download</a></p>
                <p><strong>Possible issues:</strong></p>
                <p>• File uses unsupported compression (Meshopt)</p>
                <p>• CORS headers missing</p>
                <p>• File corruption</p>
                <p>• GitHub Pages not properly configured</p>
            `;
            document.getElementById('info').appendChild(troubleshoot);
        }
        
        function checkARSupport() {
            if ('xr' in navigator) {
                navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                    if (supported) {
                        arButton.style.display = 'block';
                        arButton.addEventListener('click', startAR);
                    } else {
                        showARInstructions();
                    }
                });
            } else {
                showARInstructions();
            }
        }
        
        function showARInstructions() {
            const arInfo = document.createElement('div');
            arInfo.innerHTML = `
                <hr>
                <p><strong>AR Requirements:</strong></p>
                <p>• Chrome/Edge on Android device</p>
                <p>• ARCore supported device</p>
                <p>• HTTPS connection</p>
                <p>• Enable WebXR flags if needed</p>
            `;
            document.getElementById('info').appendChild(arInfo);
        }
        
        function startAR() {
            updateStatus('🥽 Starting AR session...', 'success');
            arButton.disabled = true;
            
            navigator.xr.requestSession('immersive-ar', {
                requiredFeatures: ['hit-test'],
                optionalFeatures: ['dom-overlay', 'light-estimation']
            }).then((session) => {
                renderer.xr.setSession(session);
                updateStatus('🎯 AR session active!', 'success');
                
                session.addEventListener('end', () => {
                    arButton.disabled = false;
                    updateStatus('AR session ended');
                });
                
            }).catch((error) => {
                console.error('AR session failed:', error);
                updateStatus('❌ Failed to start AR', 'error');
                arButton.disabled = false;
            });
        }
        
        function animate() {
            renderer.setAnimationLoop(() => {
                // Rotate model for preview
                if (model && !renderer.xr.isPresenting) {
                    model.rotation.y += 0.005;
                }
                renderer.render(scene, camera);
            });
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        window.addEventListener('resize', onWindowResize);
        
        // Initialize everything
        init();
    </script>
</body>
</html>
